-- remsignalen en geometrie naar RD
WITH b AS (
  SELECT vin as auto, 
  time,
  value, 
  ST_Transform(geom, 28992) as geom
  FROM canbus.data_2017
  WHERE signalid = 25 AND time > '2017-09-01'--AND vin = '03662eafcd5b8852e3663484376c027b8b7ea8b30829cae92853ba97d5d63682' 
),

-- snelheidsmetingen en geometrie
v AS (
  SELECT vin as auto, 
  value as speed, 
  time,
  ST_Transform(geom, 28992) as geom
  FROM canbus.data_2017
  WHERE signalid = 191 AND time > '2017-09-01' --AND vin = '03662eafcd5b8852e3663484376c027b8b7ea8b30829cae92853ba97d5d63682' 
),

bk AS(
	SELECT 
		b.*, 
		CASE WHEN b.value - LAG(b.value, -1) OVER(ORDER BY auto, time) = 1 AND b.auto = LAG(b.auto, -1) OVER(ORDER BY auto, time) THEN LAG(b.time, -1) OVER(ORDER BY auto, time)
			ELSE NULL
			END as time2,
		CASE WHEN b.value - LAG(b.value, -1) OVER(ORDER BY auto, time) = 1 AND b.auto = LAG(b.auto, -1) OVER(ORDER BY auto, time) THEN 'brakeon'
			ELSE 'brakeoff'
			END as aanuit
	FROM b
),

b3 AS (
	SELECT bk.auto as auto, bk.time as aan, bk.time2 as uit, bk.aanuit as signal, geom, null::integer as "value" --, 'brake'::text as "signal"
	FROM bk
	UNION 
	SELECT auto, time as aan, null::timestamp as uit, 'speed'::text as "signal", geom, speed as value 
	FROM v
	ORDER by aan
),

b4 AS (
	SELECT auto, aan, uit, geom, value, signal, 
	CASE WHEN signal = 'brakeon' AND uit > aan THEN LAG(value, -1) OVER(ORDER BY auto, aan)
		WHEN signal = 'brakeoff' AND uit is NULL THEN LAG(value, 1) OVER(ORDER BY auto, aan)
		ELSE NULL
	END as v0,
	EXTRACT(EPOCH FROM uit - aan) as dt
	FROM b3
	), -- SELECT * FROM b4

brakeoff AS(
SELECT auto, time, geom from b where value = 0
),

-- selecteer rem-uit momenten
c as (SELECT auto, aan, v0 as v1 FROM b4 WHERE signal = 'brakeoff')

-- voeg snelheid en tijdstip van rem-uit toe aan rem-aan o.b.v. timestamp
SELECT b4.auto, b4.aan as brakeon, b4.uit as brakeoff, b4.v0, c.v1, b4.dt, b4.geom FROM b4
JOIN c ON b4.uit = c.aan and b4.auto = c.auto;